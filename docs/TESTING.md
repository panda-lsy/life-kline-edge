# 八字计算单元测试说明

## 📋 测试概述

本测试套件为八字计算模块提供全面的单元测试覆盖,确保核心算法的正确性和稳定性。

## 🎯 测试覆盖范围

### 测试文件
- `src/utils/bazi/__tests__/bazi.test.ts` - 八字计算单元测试

### 测试用例统计
- **总测试数**: 40+ 个
- **覆盖场景**: 12 大类
- **目标覆盖率**: > 85%

## 📝 测试分类

### 1. 基础功能测试 (4 个用例)
- ✅ 计算四柱八字
- ✅ 计算五行强弱
- ✅ 计算大运
- ✅ 返回计算元数据

### 2. 性别差异测试 (2 个用例)
- ✅ 男性顺行大运
- ✅ 女性逆行大运

### 3. 不同日期测试 (3 个用例)
- ✅ 闰年日期
- ✅ 年末日期
- ✅ 年初日期

### 4. 不同时间测试 (3 个用例)
- ✅ 子时处理
- ✅ 午时处理
- ✅ 亥时处理

### 5. 已知案例验证 (3 个用例)
- ✅ 案例1: 1990年1月1日男性
- ✅ 案例2: 1985年5月15日女性
- ✅ 案例3: 2000年千年宝宝

### 6. 边界情况测试 (4 个用例)
- ✅ 最小有效日期
- ✅ 最大合理日期
- ✅ 所有24小时
- ✅ 所有12个月份

### 7. 数据类型验证 (2 个用例)
- ✅ 天干有效性验证
- ✅ 地支有效性验证
- ✅ 五行计数类型验证

### 8. 性能测试 (2 个用例)
- ✅ 单次计算 < 100ms
- ✅ 批量计算 100 次

### 9. 时区处理测试 (2 个用例)
- ✅ 东八区处理
- ✅ 不同时区处理

### 10. 大运周期测试 (3 个用例)
- ✅ 8个周期验证
- ✅ 每10年一运
- ✅ 起运年龄合理性

### 11. 错误处理测试 (2 个用例)
- ✅ 无效日期格式
- ✅ 无效时间格式

### 12. 连续性测试 (2 个用例)
- ✅ 相邻日期递增
- ✅ 相邻年份递增

## 🚀 运行测试

### 前置要求

首先需要安装测试依赖:

```bash
# 安装 Vitest 和相关依赖
npm install --save-dev vitest @vitest/ui happy-dom @vitest/coverage-v8

# 如果遇到文件锁定错误,关闭所有IDE和终端后重试
```

### 运行命令

```bash
# 运行所有测试
npm test

# 以交互模式运行测试
npm run test:ui

# 生成测试覆盖率报告
npm run test:coverage
```

### 预期结果

所有测试应该通过,输出类似:

```
 ✓ src/utils/bazi/__tests__/bazi.test.ts (40)
   ✓ 基础功能测试 (4)
   ✓ 性别差异测试 (2)
   ✓ 不同日期测试 (3)
   ✓ 不同时间测试 (3)
   ✓ 已知案例验证 (3)
   ✓ 边界情况测试 (4)
   ✓ 数据类型验证 (3)
   ✓ 性能测试 (2)
   ✓ 时区处理测试 (2)
   ✓ 大运周期测试 (3)
   ✓ 错误处理测试 (2)
   ✓ 连续性测试 (2)

 Test Files  1 passed (1)
     Tests  40 passed (40)
```

## 📊 测试覆盖率

运行 `npm run test:coverage` 后,预期覆盖率:

| 文件 | 语句覆盖率 | 分支覆盖率 | 函数覆盖率 | 行覆盖率 |
|------|-----------|-----------|-----------|---------|
| bazi.ts | > 90% | > 85% | 100% | > 90% |

## 🔍 已知案例说明

### 案例1: 1990年1月1日中午12点
- **年柱**: 己巳
- **性别**: 男
- **验证点**: 年柱天干地支正确性

### 案例2: 1985年5月15日
- **年柱**: 乙丑
- **性别**: 女
- **验证点**: 女性逆行大运

### 案例3: 2000年1月1日 (千年宝宝)
- **年柱**: 庚辰
- **性别**: 男
- **验证点**: 闰年、龙年、千禧年

## ⚠️ 注意事项

### 时区处理
- 真太阳时计算依赖经度和时区
- 测试中使用简化实现
- 生产环境需更精确的天文算法

### 性能要求
- 单次计算应 < 100ms
- 批量计算应稳定不崩溃

### 边界情况
- 支持日期范围: 1900-当前年份
- 支持24小时制
- 自动处理闰年

## 📈 未来改进

### 待补充测试
- [ ] 更多历史人物八字验证
- [ ] 跨时区边界测试
- [ ] 极端经纬度测试
- [ ] 性能基准测试

### 集成测试
- [ ] 与前端表单集成测试
- [ ] 与 K 线图生成集成测试
- [ ] 与历史记录存储集成测试

---

**最后更新**: 2026-01-09
