# PDF导出功能需求文档

## Introduction

PDF导出功能是"人生K线"应用的核心功能之一,允许用户将八字分析、K线图、五维评分等完整分析结果导出为高质量的PDF报告,以便用户保存、分享和打印。

该功能对于提升用户体验、增强应用的专业性、以及满足用户的保存和分享需求至关重要。

## Alignment with Product Vision

PDF导出功能支持产品愿景中的以下目标:

1. **实用价值**: 提供完整的、可保存的分析报告,使用户能够随时查看和分享分析结果
2. **专业性**: 通过高质量的PDF输出,体现应用的专业水准和技术实力
3. **用户体验**: 一键导出,简单易用,提升用户满意度
4. **文化传承**: 精美的PDF报告设计,体现中国传统文化的美学价值

## Requirements

### Requirement 1: 完整内容导出

**User Story:** 作为用户,我希望能够将完整的分析结果导出为PDF,包括封面、目录、八字排盘、五行关系、K线图、六维度分析、开运指南、大运流年、综合建议等所有页面,以便我能够保存完整的分析报告。

#### Acceptance Criteria

1. WHEN 用户点击"导出PDF"按钮 THEN 系统应该生成包含11个页面的完整PDF报告
2. IF PDF生成成功 THEN 系统应该自动下载PDF文件到用户设备
3. WHEN PDF生成过程中 THEN 系统应该显示进度提示
4. IF PDF生成失败 THEN 系统应该显示清晰的错误信息

### Requirement 2: 智能分页

**User Story:** 作为用户,我希望PDF中的所有内容都能完整显示,不会被截断,包括K线图、表格、长文本等内容,以便我能够查看完整的分析结果。

#### Acceptance Criteria

1. WHEN 内容超过单页容量 THEN 系统应该自动分页到下一页
2. IF 表格或图表跨越页面 THEN 系统应该确保它们不被截断
3. WHEN 系统进行分页时 THEN 系统应该在合理的断点处分页(如段落之间、章节之间)
4. IF 某个元素无法分割 THEN 系统应该将其整体移到下一页

### Requirement 3: 高质量K线图渲染

**User Story:** 作为用户,我希望PDF中的K线图清晰可读,坐标轴精确,能够准确展示人生运势走势,以便我能够清楚地看到分析结果。

#### Acceptance Criteria

1. WHEN 渲染K线图时 THEN K线宽度应该在8-20mm之间,确保可读性
2. WHEN 数据点较多时 THEN 系统应该调整K线宽度以适应页面
3. WHEN 绘制坐标轴时 THEN 系统应该使用智能刻度算法生成合适的刻度
4. IF K线图包含100年数据 THEN 系统应该能够正确渲染所有数据点
5. WHEN 生成SVG时 THEN 系统应该支持高DPI(300 DPI)以确保打印质量

### Requirement 4: 多主题支持

**User Story:** 作为用户,我希望能够选择不同的主题风格导出PDF,包括中国风、赛博朋克、极简三种风格,以便我能够根据自己的喜好选择。

#### Acceptance Criteria

1. WHEN 用户选择"中国风"主题 THEN PDF应该使用红色、金色等传统色彩
2. WHEN 用户选择"赛博朋克"主题 THEN PDF应该使用霓虹紫、蓝色等科技感色彩
3. WHEN 用户选择"极简"主题 THEN PDF应该使用黑白灰等简约色彩
4. IF 用户未选择主题 THEN 系统应该默认使用"中国风"主题

### Requirement 5: 模块化架构

**User Story:** 作为开发者,我希望PDF导出功能采用模块化架构,每个模块职责单一,代码可维护、可测试,以便我能够轻松维护和扩展功能。

#### Acceptance Criteria

1. WHEN 代码组织时 THEN 每个文件应该有明确的单一职责(如分页引擎、布局引擎、样式系统)
2. WHEN 渲染页面时 THEN 每个页面渲染器应该独立实现,互不影响
3. WHEN 引用样式时 THEN 样式应该集中在样式系统中,避免硬编码
4. IF 需要添加新页面 THEN 开发者应该只需要创建新的渲染器类,无需修改现有代码

## Non-Functional Requirements

### Code Architecture and Modularity

- **单一职责原则**: 每个类/文件应该只有一个明确的职责
- **模块化设计**: 核心服务(分页、布局、缓存)应该独立模块,可复用
- **依赖管理**: 最小化模块间的依赖,使用接口定义契约
- **清晰接口**: 定义清晰的公共API,隐藏实现细节

**具体要求**:
- 单文件代码行数 < 300行
- 单个函数行数 < 50行
- 使用抽象基类定义页面渲染器接口
- 使用类型接口定义服务层契约
- 避免HTML字符串拼接,使用DOM API或React组件

### Performance

- **PDF生成速度**: 11页PDF生成时间 < 10秒
- **缓存性能**: 相同内容再次生成时间 < 2秒
- **内存占用**: PDF生成过程中内存占用 < 200MB
- **CPU使用率**: 峰值CPU使用率 < 80%

**具体要求**:
- 使用并行渲染提高效率(Web Worker或Promise.all)
- 实现基于内容哈希的LRU缓存机制
- 优化html2canvas配置,减少重复计算
- 使用文档片段(DocumentFragment)减少DOM重排

### Security

- **XSS防护**: 避免使用innerHTML插入用户数据,使用textContent或DOM API
- **敏感信息**: 确保API密钥等敏感信息不在前端代码中暴露
- **输入验证**: 对用户输入进行严格的类型验证(使用Zod)

### Reliability

- **错误处理**: 完善的错误捕获和错误提示,区分不同错误类型(DOM错误、Canvas错误、PDF错误)
- **测试覆盖**: 单元测试覆盖率 > 80%
- **浏览器兼容**: 支持主流浏览器(Chrome、Firefox、Safari、Edge最新版本)
- **降级处理**: 如果html2canvas失败,提供降级方案(如纯文本导出)

### Usability

- **进度提示**: PDF生成过程中显示详细的进度信息(当前页/总页数,百分比)
- **错误提示**: 错误信息应该清晰、可操作,告诉用户具体问题和解决方法
- **文件命名**: 自动生成有意义的文件名(如"人生K线分析报告_张三_20260111.pdf")
- **水印**: 每页底部应该添加"由阿里云ESA提供加速"水印

## Dependencies

### 外部依赖

- **html2canvas**: ^1.4.1 - DOM转Canvas
- **jspdf**: ^4.0.0 - PDF生成
- **lucide-react**: ^0.562.0 - 图标库

### 内部依赖

- **lunar-javascript**: 八字计算数据
- **recharts**: K线图数据源
- **zustand**: 状态管理(获取用户分析结果)

## Constraints

### 技术约束

- 必须支持A4纸张尺寸(210mm × 297mm)
- 必须支持中文字体(微软雅黑、PingFang SC等)
- 必须在浏览器环境中运行(不依赖服务器端渲染)

### 业务约束

- PDF内容必须与网页显示结果一致
- PDF必须包含所有11个分析页面
- PDF文件大小应该控制在5MB以内

---

**文档版本**: 1.0
**创建日期**: 2026-01-11
**作者**: AI Assistant
**项目**: 人生 K 线 - Life K-line Edge
